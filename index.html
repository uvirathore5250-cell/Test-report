<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness AI Analysis Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        @media print { .no-print { display: none; } .print-area { display: block !important; } }
        .input-box { border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; font-weight: 700; width: 100%; transition: 0.3s; }
        .input-box:focus { border-color: #2563eb; outline: none; background: #f8fafc; }
        .label-text { font-size: 11px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .card-header { background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; padding: 20px; text-align: center; border-radius: 1.5rem 1.5rem 0 0; }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8">

    <div class="max-w-6xl mx-auto no-print bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200">
        <div class="card-header">
            <h1 class="text-3xl font-black italic uppercase tracking-tighter">Fitness AI <span class="text-white opacity-80">Analysis Portal</span></h1>
            <p class="text-[10px] font-bold opacity-80 mt-1">PRO-LEVEL ACCURACY FOR TANITA SLIPS</p>
        </div>

        <div class="p-8 grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="space-y-6">
                <div class="bg-slate-50 p-6 rounded-3xl border-2 border-dashed border-slate-300 text-center">
                    <input type="file" accept="image/*" id="fileInput" onchange="preview(event)" class="text-sm font-bold text-slate-500">
                </div>
                <div class="bg-black rounded-[2rem] h-[350px] flex items-center justify-center overflow-hidden border-4 border-white shadow-inner relative">
                    <img id="imgViewer" class="hidden w-full h-full object-contain">
                    <p id="placeholderText" class="text-slate-500 font-bold text-sm uppercase">Preview Slip Here</p>
                </div>
                <button onclick="startAIScan()" id="scanBtn" class="w-full bg-blue-600 text-white py-6 rounded-2xl font-black text-2xl uppercase italic shadow-xl hover:bg-blue-700 transition-all active:scale-95">
                    Run AI Scan
                </button>
            </div>

            <div class="space-y-6">
                <div class="bg-yellow-50 p-6 rounded-[2rem] border border-yellow-100">
                    <label class="label-text">Client Full Name</label>
                    <input type="text" id="c_name" class="input-box border-yellow-200" placeholder="ENTER NAME">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="label-text">Weight (kg)</label><input type="number" step="0.1" id="c_w" class="input-box"></div>
                    <div><label class="label-text">BMI Value</label><input type="number" step="0.1" id="c_bmi" class="input-box"></div>
                    <div><label class="label-text">Body Fat %</label><input type="number" step="0.1" id="c_fat" class="input-box"></div>
                    <div><label class="label-text">Muscle Mass (kg)</label><input type="number" step="0.1" id="c_mus" class="input-box"></div>
                    <div><label class="label-text">TBW % (Water)</label><input type="number" step="0.1" id="c_wat" class="input-box"></div>
                    <div><label class="label-text">BMR (kcal)</label><input type="number" id="c_bmr" class="input-box"></div>
                    <div><label class="label-text">Metabolic Age</label><input type="number" id="c_mage" class="input-box"></div>
                    <div><label class="label-text">Visceral Fat</label><input type="number" id="c_visc" class="input-box"></div>
                    <div class="col-span-2"><label class="label-text">Medical Condition / Note</label><input type="text" id="c_med" class="input-box" placeholder="e.g. Hypertension"></div>
                </div>
                
                <button onclick="generateFinalPDF()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl uppercase italic shadow-2xl hover:bg-black transition-all">Generate Professional Report</button>
            </div>
        </div>
    </div>

    <div id="pdfReport" class="hidden bg-white p-12 max-w-4xl mx-auto text-slate-900 print-area" style="min-height: 1100px;">
        <div class="border-b-4 border-slate-900 pb-4 mb-8">
            <h1 class="text-3xl font-black text-center uppercase">Comprehensive Health & Fitness Report</h1>
            <p class="text-center font-bold text-slate-500 mt-2 uppercase tracking-widest">
                Client: <span id="r_name" class="text-slate-900 underline"></span> | Date: <span id="r_date" class="text-slate-900"></span>
            </p>
        </div>

        <div class="space-y-10 font-bold">
            <section>
                <h2 class="text-xl font-black border-l-8 border-blue-700 pl-4 mb-6 uppercase italic bg-blue-50 py-1">1. Body Composition Analysis</h2>
                <div id="r_comp" class="space-y-3 ml-6">
                    </div>
            </section>

            <section>
                <h2 class="text-xl font-black border-l-8 border-slate-900 pl-4 mb-6 uppercase italic bg-slate-50 py-1">2. Summary & Recommendations</h2>
                <div id="r_summary" class="space-y-4 ml-6 italic text-slate-700 leading-relaxed">
                    </div>
            </section>
        </div>
        
        <div class="mt-20 pt-8 border-t border-slate-100 text-center">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Certified Fitness Analysis Powered by Tanita SC-330 Technology</p>
        </div>
    </div>

    <script>
        let selectedFile;
        function preview(e) {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    document.getElementById('imgViewer').src = ev.target.result;
                    document.getElementById('imgViewer').classList.remove('hidden');
                    document.getElementById('placeholderText').classList.add('hidden');
                };
                reader.readAsDataURL(selectedFile);
            }
        }

        async function startAIScan() {
            if (!selectedFile) return alert("Pehle BMI slip ki photo select karein!");
            const btn = document.getElementById('scanBtn');
            btn.innerText = "Scanning... Please Wait";
            
            try {
                const { data: { text } } = await Tesseract.recognize(selectedFile, 'eng');
                // Extracting numbers with 1 decimal place
                const val = text.match(/\d+\.\d+/g) || [];
                
                // FIXED MAPPING FOR TANITA SC-330
                document.getElementById('c_w').value = val[0] || "";    // Weight: 58.5
                document.getElementById('c_fat').value = val[1] || "";  // Fat: 18.9
                document.getElementById('c_mus').value = val[3] || "";  // Muscle: 44.9
                document.getElementById('c_wat').value = val[5] || "";  // Water: 52.0
                document.getElementById('c_bmi').value = val[7] || "";  // BMI: 18.9

                // Fixed values for BMR, Age, Visceral
                const bmrMatch = text.match(/(\d{4})\s*kcal/i);
                if(bmrMatch) document.getElementById('c_bmr').value = bmrMatch[1]; // 1347

                const ageMatch = text.match(/AGE\s*(\d+)/i);
                if(ageMatch) document.getElementById('c_mage').value = ageMatch[1]; // 24

                const viscMatch = text.match(/VISCERAL FAT RATING\s*(\d+)/i);
                if(viscMatch) document.getElementById('c_visc').value = viscMatch[1]; // 4

                alert("AI Scan Complete! Ek baar data verify kar lein.");
            } catch (e) { alert("Scan fail ho gaya. Kripya photo saaf khinchein."); }
            btn.innerText = "Run AI Scan Again";
        }

        function generateFinalPDF() {
            const get = (id) => document.getElementById(id).value;
            const r_div = document.getElementById('pdfReport');
            r_div.classList.remove('hidden');

            document.getElementById('r_name').innerText = get('c_name') || "Client";
            document.getElementById('r_date').innerText = new Date().toLocaleDateString('en-GB', {day:'numeric', month:'long', year:'numeric'});

            const bmi = parseFloat(get('c_bmi'));
            const fat = parseFloat(get('c_fat'));
            const visc = parseInt(get('c_visc'));

            // PROFESSIONAL LOGIC (Red/Green Indicators)
            document.getElementById('r_comp').innerHTML = `
                <p>- Weight: ${get('c_w')} kg ${get('c_w') < 60 ? '<span class="text-orange-500">(Underweight Range)</span>':'<span class="text-green-600">(Healthy)</span>'}</p>
                <p>- BMI: ${get('c_bmi')} ${bmi > 25 ? '<span class="text-red-600">(Overweight range)</span>':'<span class="text-green-600">(Healthy)</span>'}</p>
                <p>- Body Fat %: ${get('c_fat')}% ${fat > 22 ? '<span class="text-red-600">(High)</span>':'<span class="text-green-600">(Healthy)</span>'}</p>
                <p>- Muscle Weight: ${get('c_mus')} kg <span class="text-green-600">(Perfect)</span></p>
                <p>- Visceral Fat: ${get('c_visc')} ${visc > 10 ? '<span class="text-red-600">(Warning: Organ Fat High)</span>':'<span class="text-green-600">(Healthy, but monitor)</span>'}</p>
                <p>- Water %: ${get('c_wat')}% ${get('c_wat') < 55 ? '<span class="text-orange-600">(Low, should be >60%)</span>':'<span class="text-green-600">(Good)</span>'}</p>
                <p>- BMR: ${get('c_bmr')} kcal</p>
                <p>- Metabolic Age: ${get('c_mage')} yrs</p>
            `;

            document.getElementById('r_summary').innerHTML = `
                <p>• Medical History: <span class="text-blue-700">${get('c_med') || 'None Reported'}</span></p>
                <p>• Your Metabolic Age is ${get('c_mage')}. Maintaining a low metabolic age is key for longevity.</p>
                <p>• Recommendation: Increase hydration (Water intake) to improve metabolic function.</p>
            `;

            const opt = { 
                margin: 0.5, 
                filename: `${get('c_name')}_Analysis_Report.pdf`, 
                html2canvas: { scale: 3 }, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
            };
            
            html2pdf().set(opt).from(r_div).save().then(() => r_div.classList.add('hidden'));
        }
    </script>
</body>
</html>

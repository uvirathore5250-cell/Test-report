<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanita AI Scanner V5 - Ultimate Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <style>
        @media print { .no-print { display: none; } .print-area { display: block !important; } }
        .input-box { border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px; font-weight: 800; width: 100%; font-size: 1.1rem; color: #1e293b; }
        .input-box:focus { border-color: #2563eb; background-color: #f8fafc; outline: none; }
        .label-text { font-size: 11px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 2px; display: block; }
    </style>
</head>
<body class="bg-slate-100 p-2 md:p-6 font-sans text-slate-900">

    <div class="max-w-5xl mx-auto no-print bg-white rounded-[2.5rem] shadow-2xl border-t-[12px] border-blue-600 p-6 md:p-10">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-black italic uppercase tracking-tighter text-slate-800">Tanita AI Scanner <span class="text-blue-600">V5</span></h1>
            <p class="text-slate-400 font-bold text-xs mt-1 underline">OPTIMIZED FOR SC-330 SLIPS</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="space-y-6">
                <div class="bg-slate-50 p-4 rounded-2xl border-2 border-dashed border-slate-300">
                    <input type="file" accept="image/*" id="fileInput" onchange="preview(event)" class="w-full text-sm font-bold cursor-pointer">
                </div>
                
                <div class="bg-black rounded-[2rem] h-[450px] flex items-center justify-center overflow-hidden shadow-inner border-4 border-white">
                    <img id="imgViewer" class="hidden w-full h-full object-contain">
                    <div id="statusMsg" class="text-slate-500 font-black text-xs uppercase text-center p-10">
                        <p>Upload BMI Slip</p>
                        <p class="text-[9px] mt-2 text-slate-600 italic font-normal">Keep slip straight for 100% accuracy</p>
                    </div>
                </div>

                <button id="scanBtn" onclick="startDeepScan()" class="w-full bg-blue-600 text-white py-6 rounded-2xl font-black text-2xl uppercase italic tracking-widest shadow-xl hover:bg-blue-700 active:scale-95 transition-all">
                    <span id="btnText">Run AI Scan</span>
                </button>
            </div>

            <div class="space-y-6 bg-slate-50 p-6 rounded-[2rem] border border-slate-200">
                <div>
                    <label class="label-text">Client Name</label>
                    <input type="text" id="name" class="input-box bg-yellow-50 border-slate-300" placeholder="ENTER NAME">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 grid grid-cols-2 gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="col-span-2 font-black text-blue-600 text-[10px] uppercase border-b pb-1 mb-1">Critical Metrics</h3>
                        <div><label class="label-text">Weight (kg)</label><input type="text" id="v_w" class="input-box"></div>
                        <div><label class="label-text">BMI Value</label><input type="text" id="v_bmi" class="input-box"></div>
                        <div><label class="label-text">Muscle Mass (kg)</label><input type="text" id="v_mus" class="input-box"></div>
                        <div><label class="label-text">Body Fat %</label><input type="text" id="v_fat" class="input-box"></div>
                    </div>

                    <div class="col-span-2 grid grid-cols-2 gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="col-span-2 font-black text-slate-500 text-[10px] uppercase border-b pb-1 mb-1">Body Composition</h3>
                        <div><label class="label-text">TBW % (Water)</label><input type="text" id="v_wat" class="input-box"></div>
                        <div><label class="label-text">Bone Mass (kg)</label><input type="text" id="v_bone" class="input-box"></div>
                        <div><label class="label-text">Visceral Fat</label><input type="text" id="v_visc" class="input-box"></div>
                        <div><label class="label-text">Metabolic Age</label><input type="text" id="v_age" class="input-box"></div>
                        <div class="col-span-2"><label class="label-text">BMR (Kcal)</label><input type="text" id="v_bmr" class="input-box bg-blue-50"></div>
                    </div>
                </div>

                <button onclick="window.print()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl uppercase italic shadow-2xl hover:bg-black">Generate Report</button>
            </div>
        </div>
    </div>

    <script>
        let selectedFile;

        function preview(e) {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('imgViewer').src = event.target.result;
                    document.getElementById('imgViewer').classList.remove('hidden');
                    document.getElementById('statusMsg').classList.add('hidden');
                };
                reader.readAsDataURL(selectedFile);
            }
        }

        async function startDeepScan() {
            if (!selectedFile) return alert("Pehle BMI slip upload karein!");
            
            const btn = document.getElementById('btnText');
            btn.innerText = "Processing Scan...";

            try {
                // High-performance OCR recognizing numbers and specific words
                const { data: { text } } = await Tesseract.recognize(selectedFile, 'eng');
                
                // CRITICAL STEP: Remove all weird symbols and normalize spaces
                const clean = text.replace(/[^a-zA-Z0-9.% \n]/g, '').replace(/\s+/g, ' ');
                console.log("Deep Scan Result:", clean);

                const findVal = (keywords, isDecimal = true) => {
                    // This creates a pattern that looks for the keyword and grabs the NEXT number after it
                    const pattern = new RegExp(`(?:${keywords})\\s*(\\d+${isDecimal ? '[.]\\d+' : ''})`, "i");
                    const match = clean.match(pattern);
                    return match ? match[1] : '';
                };

                // Aggressive Extraction Logic
                // Weight Fix: Looks for 'WEIGHT' and grabs the next decimal (e.g. 58.5)
                document.getElementById('v_w').value = findVal("WEIGHT");

                // Muscle Fix: Looks for 'MUSCLE' and grabs the next decimal (e.g. 44.9)
                document.getElementById('v_mus').value = findVal("MUSCLE MASS|MUSCLE");

                // BMI Fix: Looks for 'BMI' (e.g. 18.9)
                document.getElementById('v_bmi').value = findVal("BMI");

                // BMR Fix: Looks for number before 'kcal' (e.g. 1347)
                const bmrMatch = clean.match(/(\d{4})\s*kcal/i);
                document.getElementById('v_bmr').value = bmrMatch ? bmrMatch[1] : '';

                // Fat % Fix: (e.g. 18.9)
                document.getElementById('v_fat').value = findVal("FAT %|FAT");

                // TBW Water Fix: (e.g. 52.0)
                document.getElementById('v_wat').value = findVal("TBW %|WATER");

                // Bone Mass Fix: (e.g. 2.5)
                document.getElementById('v_bone').value = findVal("BONE MASS|BONE");

                // Visceral Fat: (Rating is usually a whole number like 4)
                document.getElementById('v_visc').value = findVal("VISCERAL FAT RATING|VISCERAL", false);

                // Metabolic Age: (Whole number like 24)
                document.getElementById('v_age').value = findVal("METABOLIC AGE|AGE", false);

                alert("Deep Scan Finished. Please check Weight, BMI, and Muscle Mass.");

            } catch (err) {
                alert("Scan failed. Photo quality check karein.");
            } finally {
                btn.innerText = "Run AI Scan Again";
            }
        }
    </script>
</body>
</html>
